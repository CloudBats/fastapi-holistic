# FastAPI-based tech stack

## Definitions

Deploy envs:
- Local (developer machine): `local`
- CI platform pipeline: `ci`
- Development (on-prem or cloud server): `dev`
- Production (on-prem or cloud server): `prod`

Python application dependencies: `deps`
- development, including static analysis, testing, and other tooling: `dev` 
- production, i.e. nothing except what the app needs to run: `prod`

## Structure

- bootstrap: `make`
- task management: `invoke`
- python interpreter:
  - local: isolated python install in user home via `pyenv`
  - dev/prod: docker container system interpreter
- virtual environment:
  - local: created and centrally managed via `pyenv virtualenv`
  - dev/prod: created with system interpreter `venv` module
  - *: `pip`, `setuptools` and `wheel` versions controlled from `requirements-build.txt` file
- package management:
  - dev deps source of truth: `pyproject.toml` managed by `poetry`
  - prod deps source of truth: `pyproject.toml` managed by `poetry`
  - dev and prod adding, removing, updating deps: via `poetry`
  - prod lock file: managed by `poetry`
- app packaging: wheel via `poetry`
- app install:
  - local: editable install via `poetry`
  - local/dev docker:
    - deps: via `pip` using dev `requirements.txt` generated via `poetry`
    - app: docker-mounted app source dir
  - prod docker:
    - deps: via `pip` using prod `requirements.txt` generated via `poetry`
    - app: via `pip` using app wheel
- app launch:
  - local: `uvicorn` with live reload
  - local/dev docker: `uvicorn` with live reload in docker container
  - prod docker: `uvicorn` managed by `gunicorn` in docker container
- container: multi-stage docker file
- format: black, isort, autoflake
- lint: pylint, flake8, mypy, black-check, isort-check
- test: pytest with coverage, vcrpy for recording HTTP responses
- db: `Postgres`
  - local: ephemeral, docker container via `invoke`
  - ci:
    - GitHub Actions: ephemeral, provisioned by platform via workflow config
  - dev: ephemeral, docker container via `invoke`
  - prod: persistent, provisioned by infra team
- web framework: FastAPI
- schema: OpenAPI as core component of FastAPI
- documentation: automatically generated by FastAPI
- configuration management: Pydantic (included in FastAPI)
- ORM: 
  - base: SQLAlchemy
  - addition: SQLModel, build by FastAPI creator on top of SQLAlchemy
- migrations: Alembic, made by SQLAlchemy creators
- middleware: FastAPI-LASER
  - Logging with `loguru`
  - Alembic migrations improvements, e.g. enum change support
  - Structured logging, automatic logging for common events (request, response, error)
  - Error handling streamlining
  - Routing made easy with default naming based on file structure, greatly reduces strings literals in routes
